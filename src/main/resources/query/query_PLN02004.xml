<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="PLN02004">
	
	<!-- Plan승인 리스트 조회 -->
	<select id="PLN0200401S" parameterClass="java.util.Map" resultClass="java.util.LinkedHashMap">
		select
			rowNumber as "rowNum"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','APPRTYPE',apprType,null) as "apprTypeName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','PROGRAMCD',programCD,null) as "programCDName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','ACTIVITYCD',activityCD,null) as "activityCDName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','RAGESPHERECD',rageSphereCD,null) as "rageSphereCDName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','OFFICECD',officeCD,null) as "officeCDName"
			<isPropertyAvailable property="grpID">
				<isNotEmpty property="grpID">
			, (case when (select dkmdtpcd from GEMP01MT where empID=t2.empID) != 'DK' then '' else (select empNm from GEMP01MT where empID=t2.empID) end) as "empNm"
				</isNotEmpty>
				<isEmpty property="grpID">
			, (select empNm from GEMP01MT where empID=t2.empID) as "empNm"
				</isEmpty>
			</isPropertyAvailable>
			, venueCD as "venueCD"
			, venueNm as "venueNm"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','VENUEGRADCD',venueGradCD,null) as "venueGradCDName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','SEGMENTCD',segmentCD,null) as "segmentCDName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','SUBSEGMENTCD',subSegmentCD,null) as "subSegmentCDName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','ADDRTPCD1',addrTpCD1,null) as "addrTpCD1Name"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','ADDRTPCD2',addrTpCD2,null) as "addrTpCD2Name"
			, tpayAmt as "tpayAmt"
			, planTQty as "planTQty"
			, avgUnitAmt as "avgUnitAmt"
			, gsvRate as "gsvRate"
			, threeMonthAvgRate as "threeMonthAvgRate"
			, commt as "commt"
			, apprCommt as "apprCommt"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','APPRSTATECD',apprStateCD_emp,null) as "apprStateCDName_emp"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','APPRSTATECD',apprStateCD,null) as "apprStateCDName"
			, apprStateCD as "apprStateCD"
			, apprStateCD_emp as "apprStateCD_emp"
			, lapprLevelNo as "lapprLevelNo"
			, levelNo as "levelNo"
			, lastApprYN as "lastApprYN"
			, nsv as "nsv"
        	, gp as "gp"
			, gpRate as "gpRate"
		from (
			select
				<!-- t.*  -->
				max(t.apprType) as apprType
				, t.programCD
				, t.activityCD
				, t.rageSphereCD
				, t.officeCD
				, t.empID
				, t.venueCD
				, t.venueNm
				, t.venueGradCD
				, t.segmentCD
				, t.subSegmentCD
				, t.addrTpCD1
				, t.addrTpCD2
				, t.tpayAmt
				, t.planTQty
				, t.avgUnitAmt
				, t.gsvRate
				, t.threeMonthAvgRate
				, t.commt
				, t.apprCommt
				, t.apprStateCD
				, t.apprStateCD_emp
				, t.lapprLevelNo
				, t.levelNo
				, t.lastApprYN
				, nvl(round((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - t.tpayAmt), 1), 0) as nsv
                , nvl(round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - t.tpayAmt) - sum(t.cogs)), 1), 0) as gp
                , nvl(case when (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - t.tpayAmt) = 0 then 0
                 		else round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - t.tpayAmt) - sum(t.cogs)) / (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - t.tpayAmt) * 100, 1) end, 0) as gpRate
				, rank() over(
					order by
						t.rageSphereCD
						, t.officeCD
						, t.empID
						, t.venueCD
				) as rowNumber
				, floor((rank() over(
					order by
						t.rageSphereCD
						, t.officeCD
						, t.empID
						, t.venueCD
				)-1)/#displayNum#+1) as pageNum
			from (
				select
					<![CDATA[
					case when activityCD <> '20' then 
						case when (e.planQty <> 0 and e.planUnitAmt > 40000) or (planTQty <> 0 AND planTQty <= 3) then '20' else '10' end
					else '10' end as apprType
					]]>
					, programCD
					, activityCD
					, c.rageSphereCD
					, c.officeCD
					, b.empID
					, a.venueCD
					, venueNm
					, venueGradCD
					, segmentCD
					, subSegmentCD
					, addrTpCD1
					, addrTpCD2
					, tpayAmt
					, planTQty
					, (
						case when planTQty=0 then 0
						else round(tpayAmt / planTQty)
						end
					) as avgUnitAmt
					, gsvRate
					, threeMonthAvgRate
					, b.commt
					, a.commt as apprCommt
					, b.apprStateCD
					, a.apprStateCD as apprStateCD_emp
					, b.lapprLevelNo
					, a.levelNo
					, (
						case when b.lapprLevelNo = a.levelNo then 'Y'
						else 'N'
						end
					) as lastApprYN
					, f.gsv * e.planQty as gsv
	                , f.duty * e.planQty as duty
	                , f.wsdc * e.planQty as wsdc
	                , f.cogs * e.planQty as cogs  
				from GPLN03MT a
				inner join GPLN01MT b
					on a.eventYM = b.eventYM
					and a.venueCD = b.venueCD
				inner join GEMP01MT c
					on b.empID = c.empID
				inner join GVEN01MT d
					on a.venueCD = d.venueCD
				inner join GPLN01DT e
                    on a.eventYM = e.eventYM
                    and a.venueCD = e.venueCD
                inner join GPRD01MT f     
                    on e.prdCD = f.prdCD
				where
					a.eventYM = #eventYM#
				and a.empID = #empID#
				and a.apprStateCD in (
					select comCode
					from F_CODE
					where
						codediv='APPRSTATECD'
					and activeFlg = 'U'
					and useYN = 'Y'
					and attrib02 = 'MNG'
				)
				<isPropertyAvailable property="programCD">
					<isNotEmpty prepend="and" property="programCD">
						programCD = #programCD#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="activityCD">
					<isNotEmpty prepend="and" property="activityCD">
						activityCD = #activityCD#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="venueGradCD">
					<isNotEmpty prepend="and" property="venueGradCD">
						venueGradCD = #venueGradCD#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="segmentCD">
					<isNotEmpty prepend="and" property="segmentCD">
						segmentCD = #segmentCD#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="subSegmentCD">
					<isNotEmpty prepend="and" property="subSegmentCD">
						subSegmentCD = #subSegmentCD#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="rageSphereCD">
					<isNotEmpty prepend="and" property="rageSphereCD">
						c.rageSphereCD = #rageSphereCD#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="officeCD">
					<isNotEmpty prepend="and" property="officeCD">
						c.officeCD = #officeCD#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="apprStateCD">
					<isNotEmpty prepend="and" property="apprStateCD">
						a.apprStateCD = #apprStateCD#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="dkmdTpCD">
					<isNotEmpty prepend="and" property="dkmdTpCD">
						b.dkmdTpCD = #dkmdTpCD#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="overGSVYN">
					<isEqual prepend="and" property="overGSVYN" compareValue="Y">
						gsvRate > 10
					</isEqual>
				</isPropertyAvailable>
				<isPropertyAvailable property="threeMonthAvg">
					<isEqual prepend="and" property="threeMonthAvg" compareValue="Y">
						<![CDATA[
						(threeMonthAvgRate < 90 or threeMonthAvgRate > 120)
						]]>
					</isEqual>
				</isPropertyAvailable>
			) t
			where 1=1
			group by
				t.programCD
				, t.activityCD
				, t.rageSphereCD
				, t.officeCD
				, t.empID
				, t.venueCD
				, t.venueNm
				, t.venueGradCD
				, t.segmentCD
				, t.subSegmentCD
				, t.addrTpCD1
				, t.addrTpCD2
				, t.tpayAmt
				, t.planTQty
				, t.avgUnitAmt
				, t.gsvRate
				, t.threeMonthAvgRate
				, t.commt
				, t.apprCommt
				, t.apprStateCD
				, t.apprStateCD_emp
				, t.lapprLevelNo
				, t.levelNo
				, t.lastApprYN
			<isPropertyAvailable property="apprType">
				<isNotEmpty prepend="" property="apprType">
					having max(t.apprType) = #apprType#
				</isNotEmpty>
			</isPropertyAvailable>
		) t2
		where 1=1
		<isPropertyAvailable property="pageNum">
			<isNotEmpty prepend="and" property="pageNum">
				pageNum = #pageNum#
			</isNotEmpty>
		</isPropertyAvailable>
	</select>
	
	<select id="PLN0200406S" parameterClass="java.util.Map" resultClass="java.util.LinkedHashMap">
		select
			count(max(t.apprType)) as "totalCount"
		from (
			select
				<![CDATA[
				case when activityCD <> '20' then 
					case when (e.planQty <> 0 and e.planUnitAmt > 40000) or (planTQty <> 0 AND planTQty <= 3) then '20' else '10' end
				else '10' end as apprType
				]]>
				, programCD
				, activityCD
				, c.rageSphereCD
				, c.officeCD
				, b.empID
				, a.venueCD
				, venueNm
				, venueGradCD
				, segmentCD
				, subSegmentCD
				, addrTpCD1
				, addrTpCD2
				, tpayAmt
				, planTQty
				, (
					case when planTQty=0 then 0
					else round(tpayAmt / planTQty)
					end
				) as avgUnitAmt
				, gsvRate
				, threeMonthAvgRate
				, b.commt
				, a.commt as apprCommt
				, b.apprStateCD
				, a.apprStateCD as apprStateCD_emp
				, b.lapprLevelNo
				, a.levelNo
				, (
					case when b.lapprLevelNo = a.levelNo then 'Y'
					else 'N'
					end
				) as lastApprYN
			from GPLN03MT a
			inner join GPLN01MT b
				on a.eventYM = b.eventYM
				and a.venueCD = b.venueCD
			inner join GEMP01MT c
				on b.empID = c.empID
			inner join GVEN01MT d
				on a.venueCD = d.venueCD
			inner join GPLN01DT e
                on a.eventYM = e.eventYM
                and a.venueCD = e.venueCD
			where
				a.eventYM = #eventYM#
			and a.empID = #empID#
			and a.apprStateCD in (
				select comCode
				from F_CODE
				where
					codediv='APPRSTATECD'
				and activeFlg = 'U'
				and useYN = 'Y'
				and attrib02 = 'MNG'
			)
			<isPropertyAvailable property="programCD">
				<isNotEmpty prepend="and" property="programCD">
					programCD = #programCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="activityCD">
				<isNotEmpty prepend="and" property="activityCD">
					activityCD = #activityCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="venueGradCD">
				<isNotEmpty prepend="and" property="venueGradCD">
					venueGradCD = #venueGradCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="segmentCD">
				<isNotEmpty prepend="and" property="segmentCD">
					segmentCD = #segmentCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="subSegmentCD">
				<isNotEmpty prepend="and" property="subSegmentCD">
					subSegmentCD = #subSegmentCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="rageSphereCD">
				<isNotEmpty prepend="and" property="rageSphereCD">
					c.rageSphereCD = #rageSphereCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="officeCD">
				<isNotEmpty prepend="and" property="officeCD">
					c.officeCD = #officeCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="apprStateCD">
				<isNotEmpty prepend="and" property="apprStateCD">
					a.apprStateCD = #apprStateCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="dkmdTpCD">
				<isNotEmpty prepend="and" property="dkmdTpCD">
					b.dkmdTpCD = #dkmdTpCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="overGSVYN">
				<isEqual prepend="and" property="overGSVYN" compareValue="Y">
					gsvRate > 10
				</isEqual>
			</isPropertyAvailable>
			<isPropertyAvailable property="threeMonthAvg">
				<isEqual prepend="and" property="threeMonthAvg" compareValue="Y">
					<![CDATA[
					(threeMonthAvgRate < 90 or threeMonthAvgRate > 120)
					]]>
				</isEqual>
			</isPropertyAvailable>
		) t
		where 1=1
		group by
			t.programCD
			, t.activityCD
			, t.rageSphereCD
			, t.officeCD
			, t.empID
			, t.venueCD
			, t.venueNm
			, t.venueGradCD
			, t.segmentCD
			, t.subSegmentCD
			, t.addrTpCD1
			, t.addrTpCD2
			, t.tpayAmt
			, t.planTQty
			, t.avgUnitAmt
			, t.gsvRate
			, t.threeMonthAvgRate
			, t.commt
			, t.apprCommt
			, t.apprStateCD
			, t.apprStateCD_emp
			, t.lapprLevelNo
			, t.levelNo
			, t.lastApprYN
		<isPropertyAvailable property="apprType">
			<isNotEmpty prepend="" property="apprType">
				having max(apprType) = #apprType#
			</isNotEmpty>
		</isPropertyAvailable>
	</select>
	
	<!-- 상위승인자 정보 -->
	<select id="PLN0200402S" parameterClass="com.kia.pln.model.GPLN01MT" resultClass="java.util.LinkedHashMap">
		select
			levelNo as "levelNo"
			, a.empID as "empID"
			, empNm as "empNm"
			, emailAddr as "emailAddr"
		from GPLN03MT a
		inner join GEMP01MT b
			on a.empID = b.empID
		where
			a.eventYM = #eventYM#
			and a.venueCD = #venueCD#
			and a.levelNo = #levelNo#+1
	</select>
	
	<!-- plan정보 승인상태 갱신 -->
	<update id="PLN0200401U" parameterClass="com.kia.pln.model.GPLN01MT">
		update GPLN01MT
		set
			apprStateCD = #apprStateCD#
			, chgID = #userID#
			, chgDate = sysdate
		where
			eventYM = #eventYM#
			and venueCD = #venueCD#
	</update>
	
	<!-- plan승인정보 승인처리 -->
	<update id="PLN0200402U" parameterClass="com.kia.pln.model.GPLN01MT">
		update GPLN03MT
		set
			apprStateCD = '50'
			, commt = #apprCommt#
			, apprDate = sysdate
			, chgID = #userID#
			, chgDate = sysdate
		where
			eventYM = #eventYM#
			and venueCD = #venueCD#
			and levelNo = #levelNo#
	</update>
	
	<!-- plan승인정보 상위자 승인요청처리 -->
	<update id="PLN0200403U" parameterClass="com.kia.pln.model.GPLN01MT">
		update GPLN03MT
		set
			apprStateCD = '20'
			, chgID = #userID#
			, chgDate = sysdate
		where
			eventYM = #eventYM#
			and venueCD = #venueCD#
			and levelNo = #levelNo#+1
	</update>

	<!-- 업소 plan 마일리지여부 업데이트 -->
	<update id="PLN0200405U" parameterClass="com.kia.pln.model.GPLN01MT">
		merge into GPLN01MT t1
		using
		(
			select                                                                                                                                      
				 #eventYM# as eventYM
				, venueCD
			from GMIL01MT
			where
				venuecd = #venueCD#
      		and #eventYM# between contractDateFrom and contractDateTo
      		and mileageStateCd = '50'
      		group by venueCD
		) t2
		on
		(
			t1.eventYM = t2.eventYM
			and t1.venueCD = t2.venueCD
		)
		when matched then
			update
			set
				t1.mileageYN = 'Y'
	</update>
	
	<!-- 최종승인시 메일보낼 하위승인자들 정보(자신제외) -->
	<select id="PLN0200403S" parameterClass="com.kia.pln.model.GPLN01MT" resultClass="java.util.LinkedHashMap">
		select
			empID as "empID"
			, max(empNm) as "empNm"
			, max(emailAddr) as "emailAddr"
		from (
			select
				b.empID
				, empNm
				, emailAddr
			from GPLN01MT a
			inner join GPLN03MT b
				on a.eventYM = b.eventYM
				and a.venueCD = b.venueCD
			inner join GEMP01MT c
				on b.empID = c.empID
			where
				a.eventYM = #eventYM#
				and a.venueCD in
	    		<iterate property="venueCDs" open="(" close=")" conjunction=",">
					#venueCDs[]#
		     	</iterate>
				and b.empID != #empID#
		)
		group by empID
	</select>
	
	<!-- 반려시 메일보낼 하위승인자들 정보(상태가 비어있거나, 승인요청인 사람 제외) -->
	<select id="PLN0200404S" parameterClass="com.kia.pln.model.GPLN01MT" resultClass="java.util.LinkedHashMap">
		select
			empID as "empID"
			, max(empNm) as "empNm"
			, max(emailAddr) as "emailAddr"
		from (
			select
				b.empID
				, empNm
				, emailAddr
				, b.apprStateCD
			from GPLN01MT a
			inner join GPLN03MT b
				on a.eventYM = b.eventYM
				and a.venueCD = b.venueCD
			inner join GEMP01MT c
				on b.empID = c.empID
			where
				a.eventYM = #eventYM#
				and a.venueCD in
				<iterate property="venueCDs" open="(" close=")" conjunction=",">
					#venueCDs[]#
		     	</iterate>
				and (b.apprStateCD is not null and b.apprStateCD != '20')
		)
		group by empID
	</select>
	
	<!-- plan승인정보 하위자 반려처리 -->
	<update id="PLN0200404U" parameterClass="com.kia.pln.model.GPLN01MT">
		update GPLN03MT
		set
			apprStateCD = #apprStateCD#
			, apprDate = sysdate
			, commt = #apprCommt#
			, chgID = #userID#
			, chgDate = sysdate
		where
			eventYM = #eventYM#
			and venueCD = #venueCD#
			and empID = #empID#
	</update>
	
	<!-- Plan승인 엑셀 조회 -->
	<select id="PLN0200405S" parameterClass="java.util.Map" resultClass="java.util.LinkedHashMap">
		select
			getLangDesc(#companyID#,#languageCD#,'F_CODE','PROGRAMCD',programCD,null) as "programCDName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','ACTIVITYCD',activityCD,null) as "activityCDName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','RAGESPHERECD',rageSphereCD,null) as "rageSphereCDName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','OFFICECD',officeCD,null) as "officeCDName"
			<isPropertyAvailable property="grpID">
				<isNotEmpty property="grpID">
			, (case when (select dkmdtpcd from GEMP01MT where empID=t.empID) != 'DK' then '' else (select empNm from GEMP01MT where empID=t.empID) end) as "empNm"
				</isNotEmpty>
				<isEmpty property="grpID">
			, (select empNm from GEMP01MT where empID=t.empID) as "empNm"
				</isEmpty>
			</isPropertyAvailable>
			, venueCD as "venueCD"
			, venueNm as "venueNm"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','VENUEGRADCD',venueGradCD,null) as "venueGradCDName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','SEGMENTCD',segmentCD,null) as "segmentCDName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','SUBSEGMENTCD',subSegmentCD,null) as "subSegmentCDName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','ADDRTPCD1',addrTpCD1,null) as "addrTpCD1Name"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','ADDRTPCD2',addrTpCD2,null) as "addrTpCD2Name"
			, tpayAmt as "tpayAmt"
			, planTQty as "planTQty"
			, avgUnitAmt as "avgUnitAmt"
			, gsvRate as "gsvRate"
			, threeMonthAvgRate as "threeMonthAvgRate"
			, commt as "commt"
			, apprCommt as "apprCommt"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','APPRSTATECD',apprStateCD_emp,null) as "apprStateCDName_emp"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','APPRSTATECD',apprStateCD,null) as "apprStateCDName"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','KINDTPCD5',kindTpCD5,null) as "kindTpCD5Name"
			, prdNm as "prdNm"
			, factoryPrice as "factoryPrice"
			, getLangDesc(#companyID#,#languageCD#,'F_CODE','QTYUNITCD',qtyUnitCD,null) as "qtyUnitCDName"
			, threeMonthAvgQty as "threeMonthAvgQty"
			, planQty as "planQty"
			, planUnitAmt as "planUnitAmt"
			, payAmt as "payAmt"
			, nvl(round((t.gsv - t.duty - t.wsdc - t.payAmt), 1), 0)  as "nsv"
			, nvl(round(((t.gsv - t.duty - t.wsdc - t.payAmt) - t.cogs), 1), 0) as "gp"
			, nvl(case when (t.gsv - t.duty - t.wsdc - t.payAmt) = 0 then 0
  				else round(((t.gsv - t.duty - t.wsdc - t.payAmt) - t.cogs) / (t.gsv - t.duty - t.wsdc - t.payAmt) * 100, 1) end, 0) as "gpRate"
		from (
			select
				programCD
				, activityCD
				, c.rageSphereCD
				, c.officeCD
				, b.empID
				, a.venueCD
				, venueNm
				, venueGradCD
				, segmentCD
				, subSegmentCD
				, addrTpCD1
				, addrTpCD2
				, tpayAmt
				, planTQty
				, (
					case when planTQty=0 then 0
					else round(tpayAmt / planTQty)
					end
				) as avgUnitAmt
				, gsvRate
				, threeMonthAvgRate
				, b.commt
				, a.commt as apprCommt
				, b.apprStateCD
				, a.apprStateCD as apprStateCD_emp
				, b.lapprLevelNo
				, a.levelNo
				, (
					case when b.lapprLevelNo = a.levelNo then 'Y'
					else 'N'
					end
				) as lastApprYN
				, f.kindTpCD5
				, f.prdNm
				, e.factoryPrice
				, f.qtyUnitCD
				, e.threeMonthAvgQty
				, e.planQty
				, e.planUnitAmt
				, e.payAmt
				, e.prdCD
				, f.gsv * e.planQty as gsv
                , f.duty * e.planQty as duty
                , f.wsdc * e.planQty as wsdc
                , f.cogs * e.planQty as cogs
			from GPLN03MT a
			inner join GPLN01MT b
				on a.eventYM = b.eventYM
				and a.venueCD = b.venueCD
			inner join GEMP01MT c
				on b.empID = c.empID
			inner join GVEN01MT d
				on a.venueCD = d.venueCD
			inner join GPLN01DT e
				on a.eventYM = e.eventYM
				and a.venueCD = e.venueCD
			inner join GPRD01MT f
				on e.prdCD = f.prdCD
			where
				a.eventYM = #eventYM#
			and a.empID = #empID#
			and a.apprStateCD in (
				select comCode
				from F_CODE
				where
					codediv='APPRSTATECD'
				and activeFlg = 'U'
				and useYN = 'Y'
				and attrib02 = 'MNG'
			)
			<isPropertyAvailable property="programCD">
				<isNotEmpty prepend="and" property="programCD">
					programCD = #programCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="activityCD">
				<isNotEmpty prepend="and" property="activityCD">
					activityCD = #activityCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="venueGradCD">
				<isNotEmpty prepend="and" property="venueGradCD">
					venueGradCD = #venueGradCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="segmentCD">
				<isNotEmpty prepend="and" property="segmentCD">
					segmentCD = #segmentCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="subSegmentCD">
				<isNotEmpty prepend="and" property="subSegmentCD">
					subSegmentCD = #subSegmentCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="rageSphereCD">
				<isNotEmpty prepend="and" property="rageSphereCD">
					c.rageSphereCD = #rageSphereCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="officeCD">
				<isNotEmpty prepend="and" property="officeCD">
					c.officeCD = #officeCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="apprStateCD">
				<isNotEmpty prepend="and" property="apprStateCD">
					a.apprStateCD = #apprStateCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="dkmdTpCD">
				<isNotEmpty prepend="and" property="dkmdTpCD">
					b.dkmdTpCD = #dkmdTpCD#
				</isNotEmpty>
			</isPropertyAvailable>
			<isPropertyAvailable property="overGSVYN">
				<isEqual prepend="and" property="overGSVYN" compareValue="Y">
					gsvRate > 10
				</isEqual>
			</isPropertyAvailable>
			<isPropertyAvailable property="threeMonthAvg">
				<isEqual prepend="and" property="threeMonthAvg" compareValue="Y">
					<![CDATA[
					(threeMonthAvgRate < 90 or threeMonthAvgRate > 120)
					]]>
				</isEqual>
			</isPropertyAvailable>
		) t
		where 1=1
		order by
			rageSphereCD
			, officeCD
			, empID
			, venueCD
	</select>

	<!-- Plan승인 리스트 조회 -->
	<select id="PLN0200407S" parameterClass="java.util.Map" resultClass="java.util.LinkedHashMap">
		select
			DECODE(rageSphereCD,'9999','미지정권역',x1.codename) as "rageSphereCDName"
			,DECODE(officeCD,'9999','미지정지점',x2.codename) as "officeCDName"
			,type as "type"
			,apprStateCDName as "apprStateCDName"
			,tpayAmt * GETTAXBASE() as "tpayAmt"
			,planTQty as "planTQty"
			,avgUnitAmt as "avgUnitAmt"
			,gsvRate as "gsvRate"
			,nsv as "nsv"
			,gp as "gp"
			,gpRate as "gpRate"
			,apprStateCD as "apprStateCD"
			,monthSeq as "monthSeq"
		from
			(
			select
				nvl(rageSphereCD, '9999') as rageSphereCD,
	            nvl(officeCD, '9999') as officeCD,
		        getLangDesc(#companyID#,#languageCD#,'F_CODE','KINDTPCD5',kindTpCD5,null) as type,
		        getLangDesc(#companyID#,#languageCD#,'F_CODE','APPRSTATECD',apprStateCD,null) as apprStateCDName,
		        sum(t.payAmt) as tpayAmt,
		        sum(t.planQty) as planTQty,
		        (case when sum(planQty)=0 then 0       
		        	else round(sum(payAmt) / sum(planQty)) end) as avgUnitAmt,
		        (case when sum(planQty_factoryPrice)=0 then 0       
		           	else ((sum(payAmt)*(1+0.0352)) / sum(planQty_factoryPrice)) * 100 end) as gsvRate,
		        apprStateCD as apprStateCD,
		        kindTpCD5 as kindTpCD5,
		        '1' as orderBySeq,
	        	'1' as monthSeq,
	        	nvl(round((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)), 1), 0)  as nsv,
                nvl(round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)), 1), 0) as gp,
                nvl(case when (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) = 0 then 0
                    else round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)) / (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) * 100, 1) end, 0) as gpRate
	    	from
	            (     
	            select
	                programCD,
	                activityCD,
	                c.rageSphereCD,
	                c.officeCD,
	                b.empID,
	                a.venueCD,
	                venueNm,
	                venueGradCD,
	                segmentCD,
	                subSegmentCD,
	                addrTpCD1,
	                addrTpCD2,
	                e.payAmt,
	                e.planQty,
	                gsvRate,
	                threeMonthAvgRate,
	                b.commt,
	                a.commt as apprCommt,
	                b.apprStateCD,
	                f.kindTpCD5,
	                e.planQty * e.factoryPrice as planQty_factoryPrice,
	                f.gsv * e.planQty as gsv,
                	f.duty * e.planQty as duty,
                	f.wsdc * e.planQty as wsdc,
                	f.cogs * e.planQty as cogs
	            from
	                GPLN03MT a     
	            inner join GPLN01MT b      
                    on a.eventYM = b.eventYM      
                    and a.venueCD = b.venueCD     
	            inner join GEMP01MT c      
                    on b.empID = c.empID     
	            inner join GVEN01MT d      
                    on a.venueCD = d.venueCD     
	            inner join GPLN01DT e      
                    on a.eventYM = e.eventYM
                    and a.venueCD = e.venueCD
	            inner join GPRD01MT f     
                    on e.prdCD = f.prdCD
	            where
	                a.eventYM = #eventYM#
                and a.empID = #empID#
                and a.apprStateCD in (
                    select
                        comCode       
                    from
                        F_CODE       
                    where
                        codediv='APPRSTATECD'        
                    and activeFlg = 'U'        
                    and useYN = 'Y'        
                    and attrib02 = 'MNG'      
                )                                                                                                                                                  
                <!-- and a.apprStateCD =  '50' -->
                <isPropertyAvailable property="rageSphereCD_pop">
					<isNotEmpty prepend="and" property="rageSphereCD_pop">
						c.rageSphereCD = #rageSphereCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="officeCD_pop">
					<isNotEmpty prepend="and" property="officeCD_pop">
						c.officeCD = #officeCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
	            ) t
			group by rageSphereCD, officeCD, kindTpCD5, apprStateCD
			union all
			select
				nvl(rageSphereCD, '9999') as rageSphereCD,
	            nvl(officeCD, '9999') as officeCD,
		        getLangDesc(#companyID#,#languageCD#,'F_CODE','OFFICECD',officeCD,null)||'지점 합계' as type,
		        '' as "apprStateCDName",
		        sum(payAmt) as "tpayAmt",
		        sum(planQty) as "planTQty",
		        (case when sum(planQty)=0 then 0       
		        	else round(sum(payAmt) / sum(planQty)) end) as avgUnitAmt,
		        (case when sum(planQty_factoryPrice)=0 then 0       
		           	else ((sum(payAmt)*(1+0.0352)) / sum(planQty_factoryPrice)) * 100 end) as gsvRate,
		        '' as "apprStateCD",
		        '' as kindTpCD5,
		        '3' as orderBySeq,
	        	'1' as monthSeq,
	        	nvl(round((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)), 1), 0)  as nsv,
                nvl(round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)), 1), 0) as gp,
                nvl(case when (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) = 0 then 0
                    else round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)) / (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) * 100, 1) end, 0) as gpRate
	    	from
	            (     
	            select
	                programCD,
	                activityCD,
	                c.rageSphereCD,
	                c.officeCD,
	                b.empID,
	                a.venueCD,
	                venueNm,
	                venueGradCD,
	                segmentCD,
	                subSegmentCD,
	                addrTpCD1,
	                addrTpCD2,
	                e.payAmt,
	                e.planQty,
	                gsvRate,
	                threeMonthAvgRate,
	                b.commt,
	                a.commt as apprCommt,
	                b.apprStateCD,
	                e.planQty * e.factoryPrice as planQty_factoryPrice,
	                f.gsv * e.planQty as gsv,
                	f.duty * e.planQty as duty,
                	f.wsdc * e.planQty as wsdc,
                	f.cogs * e.planQty as cogs  
	            from
	                GPLN03MT a     
	            inner join GPLN01MT b      
                    on a.eventYM = b.eventYM      
                    and a.venueCD = b.venueCD     
	            inner join GEMP01MT c      
                    on b.empID = c.empID     
	            inner join GVEN01MT d      
                    on a.venueCD = d.venueCD     
	            inner join GPLN01DT e      
                    on a.eventYM = e.eventYM
                    and a.venueCD = e.venueCD
	            inner join GPRD01MT f     
	                    on e.prdCD = f.prdCD
	            where
	                a.eventYM = #eventYM# 
                and a.empID = #empID# 
                and a.apprStateCD in (
                    select
                        comCode       
                    from
                        F_CODE       
                    where
                        codediv='APPRSTATECD'        
                    and activeFlg = 'U'        
                    and useYN = 'Y'        
                    and attrib02 = 'MNG'      
               	)                                                                                                                                                  
                <!-- and        a.apprStateCD =  '50' -->
                <isPropertyAvailable property="rageSphereCD_pop">
					<isNotEmpty prepend="and" property="rageSphereCD_pop">
						c.rageSphereCD = #rageSphereCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="officeCD_pop">
					<isNotEmpty prepend="and" property="officeCD_pop">
						c.officeCD = #officeCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
	            ) t
            group by rageSphereCD, officeCD
			union all
			select
				nvl(rageSphereCD, '9999') as rageSphereCD,
	            nvl(officeCD, '9999') as officeCD,
		        DECODE(officeCD,null,'미지정',getLangDesc(#companyID#,#languageCD#,'F_CODE','OFFICECD',officeCD,null))||'지점 '||substr(max(eventYM),1,4)||'년'||substr(max(eventYM),5,2)||'월(전월) 승인합계',
		        '' as "apprStateCDName",
		        sum(payAmt) as "tpayAmt",
		        sum(planQty) as "planTQty",
		        (case when sum(planQty)=0 then 0       
		         	else round(sum(payAmt) / sum(planQty)) end) as "avgUnitAmt",
		        (case when sum(planQty_factoryPrice)=0 then 0       
		            else ((sum(payAmt)*(1+0.0352)) / sum(planQty_factoryPrice)) * 100 end) as "gsvRate",
		        '' as "apprStateCD",
		        '' as kindTpCD5,
	        	'4' as orderBySeq,
	        	'2' as monthSeq,
	        	nvl(round((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)), 1), 0)  as nsv,
                nvl(round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)), 1), 0) as gp,
                nvl(case when (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) = 0 then 0
                    else round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)) / (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) * 100, 1) end, 0) as gpRate
	    	from
	            (
	            select
	                programCD,
	                activityCD,
	                c.rageSphereCD,
	                c.officeCD,
	                b.empID,
	                a.venueCD,
	                venueNm,
	                venueGradCD,
	                segmentCD,
	                subSegmentCD,
	                addrTpCD1,
	                addrTpCD2,
	                e.payAmt,
	                e.planQty,
	                gsvRate,
	                threeMonthAvgRate,
	                b.commt,
	                a.commt as apprCommt,
	                b.apprStateCD,
	                a.eventYM,
	                e.planQty * e.factoryPrice as planQty_factoryPrice,
	                f.gsv * e.planQty as gsv,
                	f.duty * e.planQty as duty,
                	f.wsdc * e.planQty as wsdc,
                	f.cogs * e.planQty as cogs
	            from
	                GPLN03MT a     
	            inner join GPLN01MT b      
                    on a.eventYM = b.eventYM      
                    and a.venueCD = b.venueCD     
	            inner join GEMP01MT c      
                    on b.empID = c.empID     
	            inner join GVEN01MT d      
                    on a.venueCD = d.venueCD     
	            inner join GPLN01DT e      
                    on a.eventYM = e.eventYM
                    and a.venueCD = e.venueCD
	            inner join GPRD01MT f     
                    on e.prdCD = f.prdCD
	            where
	                a.eventYM =  #eventYMBefore#
                and a.empID =  #empID#
                and a.apprStateCD in (
                    select
                        comCode       
                    from
                        F_CODE       
                    where
                        codediv='APPRSTATECD'        
                    and activeFlg = 'U'        
                    and useYN = 'Y'        
                    and attrib02 = 'MNG'      
                )                                                                                                                                                  
                and a.apprStateCD =  '50'
                <isPropertyAvailable property="rageSphereCD_pop">
					<isNotEmpty prepend="and" property="rageSphereCD_pop">
						c.rageSphereCD = #rageSphereCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="officeCD_pop">
					<isNotEmpty prepend="and" property="officeCD_pop">
						c.officeCD = #officeCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
	            ) t
            group by rageSphereCD, officeCD
            union all
			select
				nvl(rageSphereCD, '9999') as rageSphereCD,
	            '' as officeCD,
		        getLangDesc(#companyID#,#languageCD#,'F_CODE','RAGESPHERECD',rageSphereCD,null)||' 합계' as type,
		        '' as apprStateCDName,
		        sum(payAmt) as tpayAmt,
		        sum(planQty) as planTQty,
		        (case when sum(planQty)=0 then 0       
		         	else round(sum(payAmt) / sum(planQty)) end) as avgUnitAmt,
		        (case when sum(planQty_factoryPrice)=0 then 0       
		        	else ((sum(payAmt)*(1+0.0352)) / sum(planQty_factoryPrice)) * 100 end) as gsvRate,
		        '' as apprStateCD,
		        '' as kindTpCD5,
		        '3' as orderBySeq,
	        	'1' as monthSeq,
	        	nvl(round((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)), 1), 0)  as nsv,
                nvl(round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)), 1), 0) as gp,
                nvl(case when (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) = 0 then 0
                    else round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)) / (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) * 100, 1) end, 0) as gpRate
	    	from
	            (     
	            select
	                programCD,
	                activityCD,
	                c.rageSphereCD,
	                c.officeCD,
	                b.empID,
	                a.venueCD,
	                venueNm,
	                venueGradCD,
	                segmentCD,
	                subSegmentCD,
	                addrTpCD1,
	                addrTpCD2,
	                e.payAmt,
	                e.planQty,
	                gsvRate,
	                threeMonthAvgRate,
	                b.commt,
	                a.commt as apprCommt,
	                b.apprStateCD,
	                e.planQty * e.factoryPrice as planQty_factoryPrice,
	                f.gsv * e.planQty as gsv,
                	f.duty * e.planQty as duty,
                	f.wsdc * e.planQty as wsdc,
                	f.cogs * e.planQty as cogs 
	            from
	                GPLN03MT a     
	            inner join GPLN01MT b      
                    on a.eventYM = b.eventYM      
                    and a.venueCD = b.venueCD     
	            inner join GEMP01MT c      
                    on b.empID = c.empID     
	            inner join GVEN01MT d      
                    on a.venueCD = d.venueCD     
	            inner join GPLN01DT e      
                    on a.eventYM = e.eventYM
                    and a.venueCD = e.venueCD
	            inner join GPRD01MT f     
                    on e.prdCD = f.prdCD
	            where
	                a.eventYM =  #eventYM# 
                and a.empID =  #empID# 
                and a.apprStateCD in (
                    select
                        comCode       
                    from
                        F_CODE       
                    where
                        codediv='APPRSTATECD'        
                    and activeFlg = 'U'        
                    and useYN = 'Y'        
                    and attrib02 = 'MNG'      
                )                                                                                                                                                  
                <!-- and        a.apprStateCD =  '50' -->
                <isPropertyAvailable property="rageSphereCD_pop">
					<isNotEmpty prepend="and" property="rageSphereCD_pop">
						c.rageSphereCD = #rageSphereCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="officeCD_pop">
					<isNotEmpty prepend="and" property="officeCD_pop">
						c.officeCD = #officeCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
	            ) t
            group by rageSphereCD
			union all
			select
				nvl(rageSphereCD, '9999') as rageSphereCD,
	           '' as officeCD,
		        DECODE(rageSphereCD,null,'미지정 권역',getLangDesc(#companyID#,#languageCD#,'F_CODE','RAGESPHERECD',rageSphereCD,null))||' '||substr(max(eventYM),1,4)||'년'||substr(max(eventYM),5,2)||'월(전월) 승인합계',
		        '' as "apprStateCDName",
		        sum(payAmt) as "tpayAmt",
		        sum(planQty) as "planTQty",
		        (case when sum(planQty)=0 then 0       
		         	else round(sum(payAmt) / sum(planQty)) end) as "avgUnitAmt",
		        (case when sum(planQty_factoryPrice)=0 then 0       
		           	else ((sum(payAmt)*(1+0.0352)) / sum(planQty_factoryPrice)) * 100 end) as "gsvRate",
		        '' as "apprStateCD",
		        '' as kindTpCD5,
	        	'4' as orderBySeq,
	        	'2' as monthSeq,
	        	nvl(round((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)), 1), 0)  as nsv,
                nvl(round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)), 1), 0) as gp,
                nvl(case when (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) = 0 then 0
                    else round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)) / (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) * 100, 1) end, 0) as gpRate
	    	from
	            (
	            select
	                programCD,
	                activityCD,
	                c.rageSphereCD,
	                c.officeCD,
	                b.empID,
	                a.venueCD,
	                venueNm,
	                venueGradCD,
	                segmentCD,
	                subSegmentCD,
	                addrTpCD1,
	                addrTpCD2,
	                e.payAmt,
	                e.planQty,
	                gsvRate,
	                threeMonthAvgRate,
	                b.commt,
	                a.commt as apprCommt,
	                b.apprStateCD,
	                a.eventYM,
	                e.planQty * e.factoryPrice as planQty_factoryPrice,
	                f.gsv * e.planQty as gsv,
                	f.duty * e.planQty as duty,
                	f.wsdc * e.planQty as wsdc,
                	f.cogs * e.planQty as cogs
	            from
	                GPLN03MT a     
	            inner join GPLN01MT b      
                    on a.eventYM = b.eventYM      
                    and a.venueCD = b.venueCD     
	            inner join GEMP01MT c      
                    on b.empID = c.empID     
	            inner join GVEN01MT d      
                    on a.venueCD = d.venueCD     
	            inner join GPLN01DT e      
                    on a.eventYM = e.eventYM
                    and a.venueCD = e.venueCD
	            inner join GPRD01MT f     
                    on e.prdCD = f.prdCD
	            where
	                a.eventYM =  #eventYMBefore#
                and a.empID =  #empID#
                and a.apprStateCD in (
                    select
                        comCode       
                    from
                        F_CODE       
                    where
                        codediv='APPRSTATECD'        
                    and activeFlg = 'U'        
                    and useYN = 'Y'        
                    and attrib02 = 'MNG'      
                )                                                                                                                                                  
                and a.apprStateCD =  '50'
                <isPropertyAvailable property="rageSphereCD_pop">
					<isNotEmpty prepend="and" property="rageSphereCD_pop">
						c.rageSphereCD = #rageSphereCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="officeCD_pop">
					<isNotEmpty prepend="and" property="officeCD_pop">
						c.officeCD = #officeCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
	            ) t
            group by rageSphereCD
            union all
			select
				'' as rageSphereCD,
				'' as officeCD,
		        '총계',
		        '' as "apprStateCDName",
		        sum(payAmt) as "tpayAmt",
		        sum(planQty) as "planTQty",
		        (case when sum(planQty)=0 then 0       
		          	else round(sum(payAmt) / sum(planQty)) end) as "avgUnitAmt",
		        (case when sum(planQty_factoryPrice)=0 then 0       
		            else ((sum(payAmt)*(1+0.0352)) / sum(planQty_factoryPrice)) * 100 end) as "gsvRate",
		        '' as "apprStateCD",
		        '' as kindTpCD5,
		        '3' as orderBySeq,
	        	'1' as monthSeq,
	        	nvl(round((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)), 1), 0)  as nsv,
                nvl(round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)), 1), 0) as gp,
                nvl(case when (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) = 0 then 0
                    else round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)) / (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) * 100, 1) end, 0) as gpRate
	    	from
	            (     
	            select
	                programCD,
	                activityCD,
	                c.rageSphereCD,
	                c.officeCD,
	                b.empID,
	                a.venueCD,
	                venueNm,
	                venueGradCD,
	                segmentCD,
	                subSegmentCD,
	                addrTpCD1,
	                addrTpCD2,
	                e.payAmt,
	                e.planQty,
	                gsvRate,
	                threeMonthAvgRate,
	                b.commt,
	                a.commt as apprCommt,
	                b.apprStateCD,
	                e.planQty * e.factoryPrice as planQty_factoryPrice,
	                f.gsv * e.planQty as gsv,
                	f.duty * e.planQty as duty,
                	f.wsdc * e.planQty as wsdc,
                	f.cogs * e.planQty as cogs
	            from
	                GPLN03MT a     
	            inner join GPLN01MT b      
                    on a.eventYM = b.eventYM      
                    and a.venueCD = b.venueCD     
	            inner join GEMP01MT c      
                    on b.empID = c.empID     
	            inner join GVEN01MT d      
                    on a.venueCD = d.venueCD     
	            inner join GPLN01DT e      
                    on a.eventYM = e.eventYM
                    and a.venueCD = e.venueCD
	            inner join GPRD01MT f     
                    on e.prdCD = f.prdCD
	            where
	                a.eventYM =  #eventYM# 
                and a.empID =  #empID# 
                and a.apprStateCD in (
                    select
                        comCode       
                    from
                        F_CODE       
                    where
                        codediv='APPRSTATECD'        
                    and activeFlg = 'U'        
                    and useYN = 'Y'        
                    and attrib02 = 'MNG'      
                )                                                                                                                                                  
                <!-- and        a.apprStateCD =  '50' -->
                <isPropertyAvailable property="rageSphereCD_pop">
					<isNotEmpty prepend="and" property="rageSphereCD_pop">
						c.rageSphereCD = #rageSphereCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="officeCD_pop">
					<isNotEmpty prepend="and" property="officeCD_pop">
						c.officeCD = #officeCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
            	) t
			union all
			select
				'' as rageSphereCD,
				'' as officeCD,
		        substr(max(eventYM),1,4)||'년'||substr(max(eventYM),5,2)||'월(전월) 총 승인합계',
		        '' as "apprStateCDName",
		        sum(payAmt) as "tpayAmt",
		        sum(planQty) as "planTQty",
		        (case when sum(planQty)=0 then 0       
		        	else round(sum(payAmt) / sum(planQty)) end) as "avgUnitAmt",
		        (case when sum(planQty_factoryPrice)=0 then 0       
		            else ((sum(payAmt)*(1+0.0352)) / sum(planQty_factoryPrice)) * 100 end) as "gsvRate",
		        '' as "apprStateCD",
		        '' as kindTpCD5,
	        	'4' as orderBySeq,
	        	'2' as monthSeq,
	        	nvl(round((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)), 1), 0)  as nsv,
                nvl(round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)), 1), 0) as gp,
                nvl(case when (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) = 0 then 0
                    else round(((sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) - sum(t.cogs)) / (sum(t.gsv) - sum(t.duty) - sum(t.wsdc) - sum(t.payAmt)) * 100, 1) end, 0) as gpRate
	    	from
	            (
	            select
	                programCD,
	                activityCD,
	                c.rageSphereCD,
	                c.officeCD,
	                b.empID,
	                a.venueCD,
	                venueNm,
	                venueGradCD,
	                segmentCD,
	                subSegmentCD,
	                addrTpCD1,
	                addrTpCD2,
	                e.payAmt,
	                e.planQty,
	                gsvRate,
	                threeMonthAvgRate,
	                b.commt,
	                a.commt as apprCommt,
	                b.apprStateCD,
	                a.eventYM,
	                e.planQty * e.factoryPrice as planQty_factoryPrice,
	                f.gsv * e.planQty as gsv,
                	f.duty * e.planQty as duty,
                	f.wsdc * e.planQty as wsdc,
                	f.cogs * e.planQty as cogs
	            from
	                GPLN03MT a     
	            inner join GPLN01MT b      
                    on a.eventYM = b.eventYM      
                    and a.venueCD = b.venueCD     
	            inner join GEMP01MT c      
                    on b.empID = c.empID     
	            inner join GVEN01MT d      
                    on a.venueCD = d.venueCD     
	            inner join GPLN01DT e      
                    on a.eventYM = e.eventYM
                    and a.venueCD = e.venueCD
	            inner join GPRD01MT f     
                    on e.prdCD = f.prdCD
	            where
	                a.eventYM =  #eventYMBefore#
                and a.empID =  #empID#
                and a.apprStateCD in (
                    select
                        comCode       
                    from
                        F_CODE       
                    where
                        codediv='APPRSTATECD'        
                        and activeFlg = 'U'        
                        and useYN = 'Y'        
                        and attrib02 = 'MNG'      
                )                                                                                                                                                  
                and a.apprStateCD = '50'
                <isPropertyAvailable property="rageSphereCD_pop">
					<isNotEmpty prepend="and" property="rageSphereCD_pop">
						c.rageSphereCD = #rageSphereCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
				<isPropertyAvailable property="officeCD_pop">
					<isNotEmpty prepend="and" property="officeCD_pop">
						c.officeCD = #officeCD_pop#
					</isNotEmpty>
				</isPropertyAvailable>
	            ) t
	        ) x
        left outer join f_code x1
	        on x.rageSphereCD = x1.comcode
	        and x1.codediv = 'RAGESPHERECD'
        left outer join f_code x2
	        on x.officeCD = x2.comcode
	        and x2.codediv = 'OFFICECD'
        order by monthSeq, rageSphereCD, officeCD, orderBySeq, kindTpCD5, apprStateCD
	</select>	
	
	<!-- 최종승인시 메일보낼 상위승인자 정보 -->
	<select id="PLN0200408S" parameterClass="com.kia.pln.model.GPLN01MT" resultClass="java.util.LinkedHashMap">
		select
			empID as "empID"
			, max(empNm) as "empNm"
			, max(emailAddr) as "emailAddr"
		from (
			select
				b.empID
				, empNm
				, emailAddr
			from GPLN01MT a
			inner join GPLN03MT b
				on a.eventYM = b.eventYM
				and a.venueCD = b.venueCD
			inner join GEMP01MT c
				on b.empID = c.empID
			where
				a.eventYM = #eventYM#
				and a.venueCD in
	    		<iterate property="venueCDs" open="(" close=")" conjunction=",">
					#venueCDs[]#
		     	</iterate>
		     	and b.levelNo = #levelNo#+1      
		)
		group by empID
	</select>
</sqlMap>